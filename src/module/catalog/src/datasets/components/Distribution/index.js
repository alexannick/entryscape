import registry from 'commons/registry';
import { i18n } from 'esi18n';
import dateUtil from 'commons/util/dateUtil';
import { createSetState } from 'commons/util/util';
import {
  getTitle,
  getModifiedDate,
  getDescription,
  getDownloadURI,
  getDistributionFormat,
} from 'commons/util/metadata';
import escaDatasetNLS from 'catalog/nls/escaDataset.nls';
import DistributionActions from '../DistributionActions';
import './index.scss';

export default (vnode) => {
  const { distribution, dataset } = vnode.attrs;
  const state = {
    isExpanded: false,
    fileEntries: [],
  };
  const setState = createSetState(state);

  // @scazan Phase II
  const expandDistribution = () => {
    setState({
      isExpanded: !state.isExpanded,
    });
  };

  // @scazan Phase II

  /**
   * Gets a title from an entry with nls defaults in case there isn't one
   *
   * @param {store/Entry} entry
   * @returns {string}
   */
  const getSafeTitle = (entry) => {
    const title = getTitle(entry);

    if (title == null) {
      const namespaces = registry.get('namespaces');
      const escaDatasetLocalized = i18n.getLocalization(escaDatasetNLS);
      const downloadURI = getDownloadURI(entry);
      const subj = entry.getResourceURI();
      const metadata = entry.getMetadata();
      const source = metadata.findFirstValue(subj, namespaces.expand('dcterms:source'));

      if (downloadURI != null && downloadURI !== '') {
        return escaDatasetLocalized.defaultDownloadTitle;
      } else if (source != null && source !== '') {
        return escaDatasetLocalized.autoGeneratedAPI;
      }

      return escaDatasetLocalized.defaultAccessTitle;
    }

    return title;
  };

  return {
    view(vnode) {
      const { fileEntryURIs, refreshDistributions } = vnode.attrs;
      const title = getSafeTitle(distribution);
      const format = getDistributionFormat(distribution);
      const modificationDate = dateUtil.getMultipleDateFormats(getModifiedDate(distribution));
      const description = getDescription(distribution);

      const expandedClass = state.isExpanded ? 'expanded' : '';
      // const distributionArrowClass = state.isExpanded ? 'fa-angle-up' : 'fa-angle-down';
      const escaDataset = i18n.getLocalization(escaDatasetNLS);

      return (
        <div>
          <div tabindex="0" class="distribution__row flex--sb">
            <div class="distribution__format">
              <p class="distribution__title">{title}</p>
              <p class="file__format">
                <span class="file__format--short">{format}</span>
              </p>
            </div>
            <div class="flex--sb">
              <p class="distribution__date">{modificationDate.short}</p>
              <DistributionActions
                distribution={distribution}
                dataset={dataset}
                fileEntryURIs={fileEntryURIs}
                refreshDistributions={refreshDistributions}
              />
            </div>
          </div>

          <div class={`distribution__expand ${expandedClass}`}>
            <div>
              <div class="flex--sb">
                <div class="metadata--wrapper">
                  { description &&
                    <div class="distribution__description">
                      <h2 class="title">{escaDataset.distributionDescriptionTitle}</h2>
                      <p class="text">
                        { description }
                      </p>
                    </div>
                  }
                  <div class="distribution__format">
                    <h2 class="title">{escaDataset.distributionFormatTitle}</h2>
                    <p class="text">
                      { i18n.renderNLSTemplate(
                        escaDataset.distributionFiles,
                        { numFiles: state.fileEntries.length },
                      ) }
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    },
  };
};
